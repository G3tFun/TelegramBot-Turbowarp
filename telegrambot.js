(function (Scratch) {
  'use strict';

  if (!Scratch || !Scratch.extensions) {
    throw new Error('This environment does not support Scratch extensions.');
  }

  class HTTPHandler {
    constructor() {
      this.baseURL = '';
      this.headers = { 'Content-Type': 'application/json' };
    }

    setBaseURL(url) {
      this.baseURL = url;
    }

    setHeader(key, value) {
      this.headers[key] = value;
    }

    async get(endpoint, params = {}) {
      try {
        const url = new URL(endpoint, this.baseURL);
        Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
        const resp = await fetch(url.toString(), {
          method: 'GET',
          headers: this.headers
        });
        return await this._handleResponse(resp);
      } catch (e) {
        return this._handleError(e);
      }
    }

    async post(endpoint, data = {}) {
      try {
        const url = new URL(endpoint, this.baseURL);
        const resp = await fetch(url.toString(), {
          method: 'POST',
          headers: this.headers,
          body: JSON.stringify(data)
        });
        return await this._handleResponse(resp);
      } catch (e) {
        return this._handleError(e);
      }
    }

    async _handleResponse(response) {
      if (!response.ok) {
        throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
      }
      const ct = response.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await response.json();
      return await response.text();
    }

    _handleError(error) {
      console.error('HTTP –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è:', error);
      return { success: false, error: error.message };
    }
  }

  class TelegramBotExtension {
    constructor() {
      this.http = new HTTPHandler();
      this.botToken = '';
      this.welcomeMessage = '';
      this.commands = new Map();
      this.menus = new Map();
      this.buttonHandlers = new Map();
      
      // –î–ª—è –ø–æ–ª–ª–∏–Ω–≥–∞
      this.polling = false;
      this.offset = 0;
      this.lastMessage = '';
      this.lastChatId = '';
    }

    getInfo() {
      return {
        id: 'telegramBot',
        name: 'Telegram Bot',
        docsURI: 'https://core.telegram.org/bots/api',
        color1: '#0088cc',
        color2: '#0077b3',
        color3: '#006699',
        blocks: [
          {
            opcode: 'setBotToken',
            blockType: Scratch.BlockType.COMMAND,
            text: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞: [TOKEN]',
            arguments: {
              TOKEN: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11'
              }
            }
          },
          {
            opcode: 'startPolling',
            blockType: Scratch.BlockType.COMMAND,
            text: 'üü¢ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞'
          },
          {
            opcode: 'stopPolling',
            blockType: Scratch.BlockType.COMMAND,
            text: 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞'
          },
          {
            opcode: 'isPolling',
            blockType: Scratch.BlockType.BOOLEAN,
            text: '–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç?'
          },
          {
            opcode: 'setWelcomeMessage',
            blockType: Scratch.BlockType.COMMAND,
            text: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: [MESSAGE]',
            arguments: {
              MESSAGE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'
              }
            }
          },
          {
            opcode: 'addCommand',
            blockType: Scratch.BlockType.COMMAND,
            text: '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /[COMMAND] —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º: [MESSAGE]',
            arguments: {
              COMMAND: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: 'help'
              },
              MESSAGE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '–≠—Ç–æ —Å–ø—Ä–∞–≤–∫–∞'
              }
            }
          },
          {
            opcode: 'createMenu',
            blockType: Scratch.BlockType.COMMAND,
            text: '–°–æ–∑–¥–∞—Ç—å –º–µ–Ω—é –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /[COMMAND]',
            arguments: {
              COMMAND: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: 'menu'
              }
            }
          },
          {
            opcode: 'addButtonToMenu',
            blockType: Scratch.BlockType.COMMAND,
            text: '–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É [BUTTON_TEXT] —Å ID: [BUTTON_ID] –≤ –º–µ–Ω—é /[COMMAND]',
            arguments: {
              COMMAND: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: 'menu'
              },
              BUTTON_TEXT: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '–ö–Ω–æ–ø–∫–∞ 1'
              },
              BUTTON_ID: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: 'button1'
              }
            }
          },
          {
            opcode: 'setButtonHandler',
            blockType: Scratch.BlockType.COMMAND,
            text: '–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ [BUTTON_ID] –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: [MESSAGE]',
            arguments: {
              BUTTON_ID: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: 'button1'
              },
              MESSAGE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '–í—ã –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É!'
              }
            }
          },
          {
            opcode: 'sendMessage',
            blockType: Scratch.BlockType.COMMAND,
            text: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ [MESSAGE] –≤ —á–∞—Ç [CHAT_ID]',
            arguments: {
              CHAT_ID: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '123456789'
              },
              MESSAGE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
              }
            }
          },
          {
            opcode: 'getLastMessage',
            blockType: Scratch.BlockType.REPORTER,
            text: '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
          },
          {
            opcode: 'getLastChatId',
            blockType: Scratch.BlockType.REPORTER,
            text: 'ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞—Ç–∞'
          }
        ]
      };
    }

    setBotToken(args) {
      const token = Scratch.Cast.toString(args.TOKEN).trim();
      this.botToken = token;
      if (this.botToken) {
        this.http.setBaseURL(`https://api.telegram.org/bot${this.botToken}/`);
        console.log('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      } else {
        console.warn('–ü—É—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
      }
    }

    setWelcomeMessage(args) {
      this.welcomeMessage = Scratch.Cast.toString(args.MESSAGE);
      console.log('–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', this.welcomeMessage);
    }

    addCommand(args) {
      const command = Scratch.Cast.toString(args.COMMAND);
      const message = Scratch.Cast.toString(args.MESSAGE);
      const cmdName = command.startsWith('/') ? command : `/${command}`;
      this.commands.set(cmdName, message);
      console.log(`–ö–æ–º–∞–Ω–¥–∞ ${cmdName} –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
    }

    createMenu(args) {
      const command = Scratch.Cast.toString(args.COMMAND);
      const cmdName = command.startsWith('/') ? command : `/${command}`;
      if (!this.menus.has(cmdName)) {
        this.menus.set(cmdName, []);
        console.log(`–ú–µ–Ω—é –¥–ª—è –∫–æ–º–∞–Ω–¥—ã ${cmdName} —Å–æ–∑–¥–∞–Ω–æ`);
      }
    }

    addButtonToMenu(args) {
      const command = Scratch.Cast.toString(args.COMMAND);
      const buttonText = Scratch.Cast.toString(args.BUTTON_TEXT);
      const buttonId = Scratch.Cast.toString(args.BUTTON_ID);
      const cmdName = command.startsWith('/') ? command : `/${command}`;
      
      if (!this.menus.has(cmdName)) {
        this.menus.set(cmdName, []);
      }
      
      const menu = this.menus.get(cmdName);
      menu.push({ text: buttonText, callback_data: buttonId });
      console.log(`–ö–Ω–æ–ø–∫–∞ "${buttonText}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –º–µ–Ω—é ${cmdName}`);
    }

    setButtonHandler(args) {
      const buttonId = Scratch.Cast.toString(args.BUTTON_ID);
      const message = Scratch.Cast.toString(args.MESSAGE);
      this.buttonHandlers.set(buttonId, message);
      console.log(`–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ ${buttonId} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`);
    }

    async sendMessage(args) {
      try {
        if (!this.botToken) {
          console.error('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
          return;
        }
        
        const chat_id = Scratch.Cast.toString(args.CHAT_ID);
        const text = Scratch.Cast.toString(args.MESSAGE);
        
        const result = await this.http.post('sendMessage', {
          chat_id: chat_id,
          text: text,
          parse_mode: 'HTML'
        });
        
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', result);
        return result;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
      }
    }

    startPolling() {
      if (this.polling) {
        console.log('–ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω');
        return;
      }
      
      if (!this.botToken) {
        console.error('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º');
        return;
      }
      
      this.polling = true;
      console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω');
      this._pollUpdates();
    }

    stopPolling() {
      this.polling = false;
      console.log('–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    isPolling() {
      return this.polling;
    }

    getLastMessage() {
      return this.lastMessage || '';
    }

    getLastChatId() {
      return this.lastChatId || '';
    }

    async _pollUpdates() {
      while (this.polling) {
        try {
          const response = await this.http.get('getUpdates', {
            offset: this.offset,
            timeout: 30
          });
          
          if (response && response.result && Array.isArray(response.result)) {
            for (const update of response.result) {
              await this._processUpdate(update);
              this.offset = update.update_id + 1;
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
        }
        
        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    async _processUpdate(update) {
      try {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if (update.message) {
          const message = update.message;
          const text = message.text || '';
          const chatId = message.chat.id;
          
          this.lastMessage = text;
          this.lastChatId = String(chatId);
          
          console.log(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${text}" –æ—Ç —á–∞—Ç–∞ ${chatId}`);
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
          if (text === '/start' && this.welcomeMessage) {
            await this.http.post('sendMessage', {
              chat_id: chatId,
              text: this.welcomeMessage
            });
            console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
          }
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥
          if (this.commands.has(text)) {
            await this.http.post('sendMessage', {
              chat_id: chatId,
              text: this.commands.get(text)
            });
            console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: ${text}`);
          }
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—é
          if (this.menus.has(text)) {
            const menu = this.menus.get(text);
            if (menu.length > 0) {
              const keyboard = [];
              for (let i = 0; i < menu.length; i += 2) {
                const row = [menu[i]];
                if (menu[i + 1]) row.push(menu[i + 1]);
                keyboard.push(row);
              }
              
              await this.http.post('sendMessage', {
                chat_id: chatId,
                text: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
                reply_markup: {
                  inline_keyboard: keyboard
                }
              });
              console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é –¥–ª—è –∫–æ–º–∞–Ω–¥—ã: ${text}`);
            }
          }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
        if (update.callback_query) {
          const query = update.callback_query;
          const buttonId = query.data;
          const chatId = query.message.chat.id;
          
          console.log(`–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: ${buttonId}`);
          
          if (this.buttonHandlers.has(buttonId)) {
            await this.http.post('sendMessage', {
              chat_id: chatId,
              text: this.buttonHandlers.get(buttonId)
            });
          }
          
          // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ callback
          await this.http.post('answerCallbackQuery', {
            callback_query_id: query.id
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
      }
    }
  }

  Scratch.extensions.register(new TelegramBotExtension());
})(Scratch);
